#!/bin/bash

if [ -z $1 ]; then
	echo '[!] Usage: ./nmap-staged.sh <target>'
	exit 1
fi

target=$1

tcp100='00-tcp-top100'
if ! [ -d $tcp1kdir ]; then
echo "[+] Beginning top 100 TCP port nmap scan against $target"
	mkdir $tcp1kdir
	nmap -sS -T4 -oA $tcp100/top-100 --stats-every 60s --max-retries 3 --top-ports 100 --script banner --reason $target
else
	echo "[+] Top 1k TCP fast scan already exists. Skipping..."
fi

tcp1kdir='01-tcp-top1k'
if ! [ -d $tcp1kdir ]; then
echo "[+] Beginning top 1000 TCP port nmap scan against $target"
	mkdir $tcp1kdir
	nmap -sS -T4 -oA $tcp1kdir/top-1k --stats-every 60s --max-retries 3 --top-ports 1000 --script banner --reason $target
else
	echo "[+] Top 1k TCP fast scan already exists. Skipping..."
fi

tcpfulldir='02-tcp-full'
if ! [ -d $tcpfulldir ]; then 
	echo "[+] Running full TCP port scan against $target"
	mkdir $tcpfulldir
#	This works, but honestly is giving us a ton of junk most of the time
#	nmap -sS -T4 -A -oA $tcpfulldir/full-tcp --stats-every 60s --max-retries 3 -p- --reason $target
	nmap -sS -T4 -sV --script banner,ssh-hostkey -oA $tcpfulldir/full-tcp --stats-every 60s --max-retries 3 -p- --reason $target
else
	echo "[+] Full TCP port scan directory already exists. Skipping..."
fi

udp1kdir='03-udp-top1k'
if ! [ -d $udp1kdir ]; then
	echo "[+] Beginning top 1k UDP port nmap scan against $target"
	mkdir $udp1kdir
#	This works, but isn't worth the additional time -A adds even though it can be useful
#	We'll be faster manually enumerating most times
#	nmap -sU -T4 -A -oA $udp1kdir/top-1k --stats-every 60s --max-retries 3 --top-ports 1000 --reason $target
	nmap -sU -T4 -sV -oA $udp1kdir/top-1k --stats-every 60s --max-retries 3 --top-ports 1000 --reason $target
else
	echo "[+] Top 1k UDP intensive nmap scan already exists. Skipping..."
fi

udpfulldir='04-udp-full'
if ! [ -d $udpfulldir ]; then
	echo "[+] Beginning full UDP port nmap scan against $target"
	mkdir $udpfulldir
#	This works, but isn't worth the additional time -A adds even though it can be useful
#	We'll be faster manually enumerating most times
#	nmap -sU -T4 -A -oA $udp1kdir/top-1k --stats-every 60s --max-retries 3 --top-ports 1000 --reason $target
	nmap -sU -T4 -sV -oA $udpfulldir/full-udp --stats-every 60s --max-retries 2 -p- --reason $target
else
	echo "[+] Full UDP port scan already exists. Skipping..."
fi
