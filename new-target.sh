#!/bin/bash

function usage()
{
	echo '[!] Usage: new-target <ip address> <name>'
	exit 1
}

function valid_ip()
{
    local  ip=$1
    local  stat=1

    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        OIFS=$IFS
        IFS='.'
        ip=($ip)
        IFS=$OIFS
        [[ ${ip[0]} -le 255 && ${ip[1]} -le 255 \
            && ${ip[2]} -le 255 && ${ip[3]} -le 255 ]]
        stat=$?
    fi
    return $stat
}

if [ -z $1 ]; then
	usage
fi

if [ -z $2 ]; then
	usage
fi

target="$1"
name="$2"

if valid_ip $target; then
	oct3="$(echo ${target} | cut -d '.' -f 3)"
	oct4="$(echo ${target} | cut -d '.' -f 4)"
	target_folder="${oct3}.${oct4}-${name}"

	recon_folder="01-recon"
	exploit_folder="02-exploit"
	postexpl_folder="03-post-exploitation"

	echo "[+] Creating new target folder ${target_folder}"

	pushd . &>/dev/null
	mkdir ${target_folder}
	cd ${target_folder}
	echo "[+] Creating recon, exploit and post-exploitation folders"
	mkdir {${recon_folder}, ${exploit_folder}, ${postexpl_folder}}
	
	pushd . &>/dev/null
	cd ${recon_folder}
	echo "[+] Creating initial recon folders"
	for f in "00-unicorn" "01-nmap"; do
		mkdir "$f"
	done
	popd &>/dev/null
	
	pushd . &>/dev/null
	cd ${exploit_folder}
	echo "[+] Creating initial exploit folders"
	for f in "00-potential" "01-attempted" "02-successful"; do
		mkdir "$f"
	done
	popd &>/dev/null
	
	pushd . &>/dev/null
	cd ${postexpl_folder}
	echo "[+] Creating post exploitation folders"
	for f in "00-enumeration" "01-exploitation" "02-proof" "03-loot_and_creds"; do
		mkdir "$f"
	done	
	popd &>/dev/null

else

	echo '[!] Invalid IP address, exiting'
	exit 1
fi
